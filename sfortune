#!/usr/bin/env python3

from urllib import request as URL
from html.parser import HTMLParser
import sys
import argparse

class FactParser(HTMLParser):
	def __init__(self):
		HTMLParser.__init__(self)
		self.fact = ""
		self.factActive = False

	def handle_starttag(self, tag, attrs):
		if tag == 'p' and ("class", "fact") in attrs:
			self.factActive = True

	def handle_data(self, data):
		if self.factActive:
			self.fact = self.fact + data

	def handle_charref(self, name):
		if self.factActive:
			self.fact = self.fact + "&#" + name + ";"

	def handle_entityref(self, name):
		None

	def handle_endtag(self, tag):
		if self.factActive:
			self.factActive = False

	def getFact(self):
		return self.unescape(self.fact).strip()

def getSchneierFact(number = None):
	factUrl = "http://www.schneierfacts.com/"
	if isinstance( number, ( int ) ):
		assert(number > 0)
		factUrl = factUrl + 'fact/' + str(number)

	urlHandle = URL.urlopen(factUrl)
	return str(urlHandle.read(), "utf-8")

if __name__ == "__main__":
	# parse arguments
	parser = argparse.ArgumentParser(description='Load ironic facts about Bruce Schneier from http://www.schneierfacts.com')
	parser.add_argument('factnumber', metavar='N', type=int, nargs='?',
						help='number of the fact to load')
	args = parser.parse_args()

	# set factnumber, maybe None if there is no number given
	factNumber = args.factnumber

	try:
		factHtmlPage = getSchneierFact(factNumber)
	except:
		print('ERROR: Downloading random Schneier fact failed. Exiting.')
		sys.exit(1)

	pageParser = FactParser()
	pageParser.feed(factHtmlPage)
	pageParser.close()

	fact = pageParser.getFact()
	print(fact)
